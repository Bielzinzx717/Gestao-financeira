{% extends 'base.html' %}

{% block content %}
<h2>Olá, {{ current_user.nome }}!</h2>

<!-- Seção de estatísticas avançadas -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Top 5 Categorias de Gastos (Mês Atual)</h5>
      </div>
      <div class="card-body">
        {% if estatisticas.top_categorias %}
          <ul class="list-group">
            {% for item in estatisticas.top_categorias %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ item.categoria }}
              <span class="badge bg-danger rounded-pill">R$ {{ item.total|round(2) }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Nenhuma despesa registrada neste mês.</p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0">Comparação Mensal</h5>
      </div>
      <div class="card-body">
        <h6>Mês Atual ({{ estatisticas.comparacao_mensal.mes_atual }})</h6>
        <p class="mb-1">Receitas: <strong class="text-success">R$ {{ estatisticas.comparacao_mensal.receitas_atual|round(2) }}</strong></p>
        <p class="mb-3">Despesas: <strong class="text-danger">R$ {{ estatisticas.comparacao_mensal.despesas_atual|round(2) }}</strong></p>
        
        <h6>Mês Anterior ({{ estatisticas.comparacao_mensal.mes_anterior }})</h6>
        <p class="mb-1">Receitas: <strong class="text-success">R$ {{ estatisticas.comparacao_mensal.receitas_anterior|round(2) }}</strong></p>
        <p class="mb-3">Despesas: <strong class="text-danger">R$ {{ estatisticas.comparacao_mensal.despesas_anterior|round(2) }}</strong></p>
        
        <hr>
        <h6>Variação</h6>
        <p class="mb-1">
          Receitas: 
          {% if estatisticas.comparacao_mensal.variacao_receitas >= 0 %}
            <span class="text-success">+R$ {{ estatisticas.comparacao_mensal.variacao_receitas|round(2) }}</span>
          {% else %}
            <span class="text-danger">R$ {{ estatisticas.comparacao_mensal.variacao_receitas|round(2) }}</span>
          {% endif %}
        </p>
        <p class="mb-0">
          Despesas: 
          {% if estatisticas.comparacao_mensal.variacao_despesas >= 0 %}
            <span class="text-danger">+R$ {{ estatisticas.comparacao_mensal.variacao_despesas|round(2) }}</span>
          {% else %}
            <span class="text-success">R$ {{ estatisticas.comparacao_mensal.variacao_despesas|round(2) }}</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header bg-warning">
        <h5 class="mb-0">Previsão de Gastos</h5>
      </div>
      <div class="card-body">
        <p class="mb-2">Baseado no seu ritmo de gastos atual, a previsão para o final do mês é:</p>
        <h4 class="text-danger mb-3">R$ {{ estatisticas.previsao_gastos|round(2) }}</h4>
        <p class="text-muted mb-0">Média de despesas dos últimos 3 meses: <strong>R$ {{ estatisticas.media_despesas_3meses|round(2) }}</strong></p>
      </div>
    </div>
  </div>
</div>

<div class="row mb-3">
  <div class="col-md-4">
    <div class="card text-bg-success text-center">
      <div class="card-body">
        <h5>Receitas</h5>
        <p>R$ {{ total_receitas|round(2) }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-danger text-center">
      <div class="card-body">
        <h5>Despesas</h5>
        <p>R$ {{ total_despesas|round(2) }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card text-bg-primary text-center">
      <div class="card-body">
        <h5>Saldo</h5>
        <p>R$ {{ saldo|round(2) }}</p>
      </div>
    </div>
  </div>
</div>

<a href="{{ url_for('nova_transacao') }}" class="btn btn-success mb-3">Nova Transação</a>

<!-- Seção de filtros avançados -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Filtros Avançados</h5>
  </div>
  <div class="card-body">
    <form method="GET" action="{{ url_for('dashboard') }}" class="row g-3">
      <div class="col-md-3">
        <label for="busca" class="form-label">Buscar por descrição</label>
        <input type="text" class="form-control" id="busca" name="busca" placeholder="Digite para buscar..." value="{{ filtro_busca or '' }}">
      </div>
      
      <div class="col-md-2">
        <label for="tipo" class="form-label">Tipo</label>
        <select class="form-select" id="tipo" name="tipo">
          <option value="todos" {% if not filtro_tipo or filtro_tipo == 'todos' %}selected{% endif %}>Todos</option>
          <option value="receita" {% if filtro_tipo == 'receita' %}selected{% endif %}>Receita</option>
          <option value="despesa" {% if filtro_tipo == 'despesa' %}selected{% endif %}>Despesa</option>
        </select>
      </div>
      
      <div class="col-md-3">
        <label for="categoria" class="form-label">Categoria</label>
        <select class="form-select" id="categoria" name="categoria">
          <option value="todas" {% if not filtro_categoria or filtro_categoria == 'todas' %}selected{% endif %}>Todas</option>
          {% for cat in categorias_disponiveis %}
          <option value="{{ cat }}" {% if filtro_categoria == cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-2">
        <label for="data_inicial" class="form-label">Data Inicial</label>
        <input type="date" class="form-control" id="data_inicial" name="data_inicial" value="{{ data_inicial_str or '' }}">
      </div>
      
      <div class="col-md-2">
        <label for="data_final" class="form-label">Data Final</label>
        <input type="date" class="form-control" id="data_final" name="data_final" value="{{ data_final_str or '' }}">
      </div>
      
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Limpar Filtros</a>
      </div>
    </form>
  </div>
</div>

<!-- ALERTAS -->
{% if saldo < 0 %}
<div class="alert alert-danger" role="alert">
  Seu saldo está negativo: R$ {{ saldo | round(2) }}. Atenção aos gastos!
</div>
{% endif %}

{% if total_receitas > 0 and saldo > total_receitas * 0.5 %}
<div class="alert alert-success" role="alert">
  Ótimo! Você poupou mais da metade da sua receita!
</div>
{% endif %}

<!-- RESUMO MENSAL -->
{% if relatorio_mensal %}
<h3>Resumo Mensal</h3>
<table class="table table-bordered mb-4">
  <thead>
    <tr>
      <th>Mês/Ano</th>
      <th>Receitas</th>
      <th>Despesas</th>
      <th>Saldo</th>
    </tr>
  </thead>
  <tbody>
    {% for r in relatorio_mensal %}
    <tr>
      <td>{{ r.mes_ano }}</td>
      <td>R$ {{ r.total_receitas | round(2) }}</td>
      <td>R$ {{ r.total_despesas | round(2) }}</td>
      <td>R$ {{ r.saldo | round(2) }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<!-- TABELA DE TRANSAÇÕES -->
<table class="table table-striped">
  <thead>
    <tr>
      <th>Descrição</th>
      <th>Tipo</th>
      <th>Categoria</th>
      <th>Valor</th>
      <th>Data</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    {% for t in transacoes %}
    <tr>
      <td>{{ t.descricao }}</td>
      <td>
        {% if t.tipo == 'receita' %}
          <span class="badge bg-success">Receita</span>
        {% else %}
          <span class="badge bg-danger">Despesa</span>
        {% endif %}
      </td>
      <td>
        {% if t.categoria %}
          <span class="badge bg-secondary">{{ t.categoria }}</span>
        {% else %}
          <span class="badge bg-light text-dark">Sem categoria</span>
        {% endif %}
      </td>
      <td>R$ {{ t.valor | round(2) }}</td>
      <td>{{ t.data.strftime('%d/%m/%Y') }}</td>
      <td>
        <a href="{{ url_for('editar_transacao', id=t.id) }}" class="btn btn-sm btn-outline-primary">Editar</a>
        <a href="{{ url_for('delete', id=t.id) }}" class="btn btn-sm btn-outline-danger">Excluir</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
